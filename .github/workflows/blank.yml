name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  JF_RT_URL: https://mgmresorts.jfrog.io
  JFROG_USERNAME: 'pkumar@mgmresorts.com'
  RT_REPO_VIRTUAL: 'rafay-poc-addon-configs-generic-dev-local'
  JFROG_CLI_LOG_LEVEL: 'ERROR'
  BUILD_NAME: 'rafay-poc'
  BUILD_ID: "rafay-poc.$(date '+%Y-%m-%d-%H-%M')"
  RBv2_SIGNING_KEY: 'mgmkey'
  DISABLE_JOB_SUMMARY: false
  JF_ACCESS_TOKEN: ${{ secrets.JFROG_TOKEN }}
  JFROG_TOKEN: ${{ secrets.JFROG_TOKEN }}
  OIDC_PROVIDER_NAME: test-exploration-oidc

permissions:
  actions: read # for detecting the Github Actions environment.
  id-token: write # for creating OIDC tokens for signing.
  packages: write # for uploading attestations.
  contents: write # to push updates while version bump and publish to repo, read is fine if there is just read operation‚Äã
  security-events: write # Required for uploading code scanning.
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        id: setup-cli
        with:
          version: 2.71.0
          oidc-provider-name: ${{env.OIDC_PROVIDER_NAME}}
          disable-job-summary: false
        env:
          JF_URL: ${{env.JF_RT_URL}}
          JFROG_CLI_RELEASES_REPO: '${{ env.JF_RT_URL }}/artifactory/${{ env.RT_REPO_VIRTUAL}}' 
          JFROG_CLI_EXTRACTORS_REMOTE: '${{ env.JF_RT_URL }}/artifactory/${{ env.RT_REPO_VIRTUAL}}'
          JF_GIT_TOKEN: ${{ secrets.GH_PAT }}
          # JF_ACCESS_TOKEN: ${{ secrets.JFROG_TOKEN }}

      - name: Set the JFrog Token
        run: echo JFROG_TOKEN=${{ steps.setup-cli.outputs.oidc-token }} >> $GITHUB_ENV

      - name: List the files
        run: ls

      - name: Xray Scan
        run: |
          jf scan . --fail=false --output ./xray-scan-report.json --extended-table=true --detailed-summary=true
        
      # - name: üîç Scan K8s manifests for security/misconfig
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: config
      #     scan-ref: .

      - name: ‚úÖ Run Checkov on YAMLs
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: true

      - name: Upload SARIF report as GitHub artifact
        uses: actions/upload-artifact@v3
        with:
          name: checkov-scan-results
          path: results.sarif


      - name: üîç Scan cert-manager addon
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: ./cert-manager
      
      - name: üîç Scan external-dns addon
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: ./external-dns



